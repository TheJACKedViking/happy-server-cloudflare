name = "happy-server-workers"
main = "src/index.ts"
compatibility_date = "2025-11-17"
compatibility_flags = ["nodejs_compat"]

# Cloudflare Account ID
account_id = "81f483e6767ea3194467ecef42840f79"

# Enable Node.js compatibility for process.env and other Node APIs
[build]
command = ""

#############################
# Development Environment
#############################
[env.dev]
name = "happy-server-workers-dev"
# DEBUG_RPC_ROUTING: Set to "true" to enable verbose RPC routing debug logs (HAP-297)
vars = { ENVIRONMENT = "development", DEBUG_RPC_ROUTING = "false" }
# Custom domain routing
routes = [
    { pattern = "happy-api-dev.enflamemedia.com", custom_domain = true }
]

# D1 Database binding (development)
[[env.dev.d1_databases]]
binding = "DB"
database_name = "happy-dev"
database_id = "402f86c0-7405-49cc-9667-93ad06fe4206"
remote = true

# R2 Bucket binding (development)
[[env.dev.r2_buckets]]
binding = "UPLOADS"
bucket_name = "happy-dev-uploads"
remote = true

# KV Namespace binding (development) - for rate limiting (HAP-409)
[[env.dev.kv_namespaces]]
binding = "RATE_LIMIT_KV"
id = "5d82d033678243aa8080971ecf538477"

# Analytics Engine binding (development) - for sync metrics (HAP-546)
[[env.dev.analytics_engine_datasets]]
binding = "SYNC_METRICS"
dataset = "sync_metrics_dev"

# Durable Objects bindings (development)
[[env.dev.durable_objects.bindings]]
name = "CONNECTION_MANAGER"
class_name = "ConnectionManager"

# Durable Objects migrations (development) - required for new DO classes
[[env.dev.migrations]]
tag = "v1"
new_classes = ["ConnectionManager"]

# Scheduled Triggers (development) - Token blacklist cleanup (HAP-504)
[env.dev.triggers]
crons = ["0 2 * * *"]  # Daily at 2 AM UTC

[env.dev.observability]
[env.dev.observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true
persist = true

[env.dev.observability.traces]
enabled = true
head_sampling_rate = 1
persist = true

#############################
# Production Environment
#############################
[env.prod]
name = "happy-server-workers-prod"
# DEBUG_RPC_ROUTING: Set to "true" to enable verbose RPC routing debug logs (HAP-297)
# Warning: Keep disabled in production to avoid performance impact
vars = { ENVIRONMENT = "production", DEBUG_RPC_ROUTING = "false" }
# Custom domain routing
routes = [
    { pattern = "happy-api.enflamemedia.com", custom_domain = true }
]

# D1 Database binding (production)
[[env.prod.d1_databases]]
binding = "DB"
database_name = "happy-prod"
database_id = "f547b6d8-035d-4550-a5cf-acea4c533901"
remote = true

# R2 Bucket binding (production)
[[env.prod.r2_buckets]]
binding = "UPLOADS"
bucket_name = "happy-prod-uploads"
remote = true

# KV Namespace binding (production) - for rate limiting (HAP-409)
[[env.prod.kv_namespaces]]
binding = "RATE_LIMIT_KV"
id = "2e9baf9f10054559a6220e78051fb336"

# Analytics Engine binding (production) - for sync metrics (HAP-546)
[[env.prod.analytics_engine_datasets]]
binding = "SYNC_METRICS"
dataset = "sync_metrics_prod"

# Durable Objects bindings (production)
[[env.prod.durable_objects.bindings]]
name = "CONNECTION_MANAGER"
class_name = "ConnectionManager"

# Durable Objects migrations (production) - required for new DO classes
[[env.prod.migrations]]
tag = "v1"
new_classes = ["ConnectionManager"]

# Scheduled Triggers (production) - Token blacklist cleanup (HAP-504)
[env.prod.triggers]
crons = ["0 2 * * *"]  # Daily at 2 AM UTC

[env.prod.observability]
[env.prod.observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true
persist = true

[env.prod.observability.traces]
enabled = true
head_sampling_rate = 1
persist = true